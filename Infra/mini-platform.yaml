# Generate SSH Keys for users
- name: Generate SSH Keys
  hosts: local
  tasks:
    - name: Generate SSH Keys for users
      openssh_keypair:
        path: "~/ssh_keys/{{ item }}"
        type: ed25519
        state: present
        comment: "{{ item }} key generated by ansible"
      loop: "{{ ssh_user }}"

# Create the development environment on Azure
- name: Create Azure VM
  hosts: local
  tasks:
  - name: Create resource group for {{ env_name }}
    azure_rm_resourcegroup:
      name: "{{ rg_name }}"
      location: "{{ rg_location }}"

  - name: Create virtual network {{ env_name }}
    azure_rm_virtualnetwork:
      resource_group: "{{ rg_name }}"
      name: "{{ vnet_name }}"
      address_prefixes: "10.0.0.0/16"

  - name: Add subnet {{ env_name }}
    azure_rm_subnet:
      resource_group: "{{ rg_name }}"
      name: "{{ subnet_name }}"
      address_prefix: "10.0.1.0/24"
      virtual_network: "{{ vnet_name }}"

  - name: Create public IP address {{ env_name }}
    azure_rm_publicipaddress:
      resource_group: "{{ rg_name }}"
      allocation_method: Static
      name: "{{ public_ip_name }}"
    register: output_ip_address

  - name: Public IP of VM {{ env_name }}
    debug:
      msg: "The public IP is {{ output_ip_address.state.ip_address }}."

  - name: Create Network Security Group that allows SSH {{ mini-platform-dev }}
    azure_rm_securitygroup:
      resource_group: "{{ rg_name }}"
      name: "{{ net_sec_grp_name }}"
      rules:
        - name: SSH
          protocol: Tcp
          destination_port_range: 22
          access: Allow
          priority: 1001
          direction: Inbound

  - name: Create virtual network interface card {{ env_name }}
    azure_rm_networkinterface:
      resource_group: "{{ rg_name }}"
      name: "{{ net_interface_name }}"
      virtual_network: "{{ vnet_name }}"
      subnet: "{{ subnet_name }}"
      public_ip_name: "{{ public_ip_name }}"
      security_group: "{{ net_sec_grp_name }}"

  - name: Create VM {{ env_name }}
    azure_rm_virtualmachine:
      resource_group: "{{ rg_name }}"
      name: "{{ env_name }}"
      vm_size: Standard_DS1_v2
      admin_username: adminmpdev
      ssh_password_enabled: false
      ssh_public_keys:
        - path: /home/adminmpdev/.ssh/authorized_keys
          key_data: "{{ lookup('file','~/ssh_keys/adminmpdev.pub') }}"
      network_interfaces: "{{ net_interface_name }}"
      image:
        offer: "0001-com-ubuntu-server-jammy"
        publisher: "canonical"
        sku: "22_04-lts"
        version: "latest"

# Create deployment user to {{ env_name }}
#- name: Add new user to VM and add public key
#  hosts: {{ ip }}
#  become: yes
#  tasks:
#    - name: Create user mike
#      user:
#        name: mike
#        state: present
#
#    - name: Add public key to authorized_keys
#      authorized_key:
#        user: mike
#        state: present
#        key: "{{ lookup('file', 'ssh_keys/mike.pub') }}"
